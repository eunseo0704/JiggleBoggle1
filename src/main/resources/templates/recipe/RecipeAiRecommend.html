<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <title>AI Î†àÏãúÌîº Ï∂îÏ≤ú</title>

    <style>
        body { font-family: Arial; padding: 20px; background: #fafafa; }
        h2 { color: #ff6b42; }

        .input-group { margin-bottom: 20px; }
        #condition { padding: 10px; width: 300px; border-radius: 6px; border: 1px solid #ccc; }
        button { padding: 10px 15px; border: none; border-radius: 6px; background-color: #ff6b42; color: white; cursor: pointer; margin-left: 10px; }
        button:hover { background-color: #e05536; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .card img { width: 100%; height: 150px; object-fit: cover; }
        .card-body { padding: 15px; }
        .title { font-size: 18px; font-weight: bold; color: #ff6b42; margin-bottom: 8px; }
        .description { white-space: pre-line; line-height: 1.5; font-size: 14px; margin-bottom: 8px; }

        /* Î™®Îã¨ */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80%; overflow-y: auto; }
        .close { float: right; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>
    <form id="mainForm" name="mainForm"  method="get" th:action="@{/searchRecipe}">

        <div th:unless="${isLoggedIn}" th:insert="fragments/header :: site-header"></div>
        <div th:if="${isLoggedIn}" th:insert="fragments/header :: jb-site-header"></div>

        <h2>üç≥ AI Î†àÏãúÌîº Ï∂îÏ≤ú</h2>

        <div class="input-group">
            <input id="condition" placeholder="Ïòà: Îã≠Í∞ÄÏä¥ÏÇ¥ Ï†ÄÎÖÅ Ï∂îÏ≤ú">
            <button onclick="ask()">Ï∂îÏ≤ú Î∞õÍ∏∞</button>
        </div>

        <div class="grid" id="grid"></div>

        <div class="modal" id="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">‚úñ</span>
                <div id="modal-body"></div>
            </div>
        </div>
    </form>


    <script>
        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        async function ask() {
            const condition = document.getElementById("condition").value.trim();
            if (!condition) { alert("Ï°∞Í±¥ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; }

            const grid = document.getElementById("grid");
            grid.innerHTML = "";

            try {
                const res = await fetch('/recipe/ai/RecipeAiRecommend', {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({condition})
                });

                if (!res.ok) { alert("API Ìò∏Ï∂ú Ïã§Ìå®: " + res.status); return; }

                const data = await res.json(); // JSON Î∞∞Ïó¥ Î∞òÌôò

                data.forEach(recipe => {
                    const card = document.createElement("div");
                    card.className = "card";

                    const img = document.createElement("img");
                    img.src = recipe.imgUrl || "https://via.placeholder.com/256x256?text=Recipe";

                    const body = document.createElement("div");
                    body.className = "card-body";

                    const h3 = document.createElement("div");
                    h3.className = "title";
                    h3.innerText = recipe.title;

                    const pDesc = document.createElement("div");
                    pDesc.className = "description";
                    // Í∞ÑÎûµÌïòÍ≤å Ïπ¥ÎìúÏóê ÌëúÏãú: Ïû¨Î£å Ï≤´ 2~3Í∞ú Ï†ïÎèÑ
                    const shortIngredients = recipe.ingredients.split(",").slice(0,3).join(", ");
                    pDesc.innerText = "Ïû¨Î£å: " + shortIngredients + (recipe.ingredients.split(",").length > 3 ? " ..." : "");

                    const btn = document.createElement("button");
                    btn.innerText = "Îçî Î≥¥Í∏∞";
                    btn.onclick = () => {
                        document.getElementById("modal-body").innerHTML =
                            `<h3>${recipe.title}</h3>
                         <p><b>Ïû¨Î£å:</b> ${recipe.ingredients}</p>
                         <p><b>Î∞©Î≤ï:</b> ${recipe.method}</p>`;
                        document.getElementById("modal").style.display = "flex";
                    };

                    body.appendChild(h3);
                    body.appendChild(pDesc);
                    body.appendChild(btn);

                    card.appendChild(img);
                    card.appendChild(body);

                    grid.appendChild(card);
                });

            } catch (err) { alert("Ïò§Î•ò Î∞úÏÉù: " + err.message); }
        }
    </script>

</body>
</html>
